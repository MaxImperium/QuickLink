# =============================================================================
# Redis Configuration for QuickLink
# =============================================================================
# Optimized for high-throughput caching and queue workload:
# - Hot path: link lookups (GET operations)
# - Background: click event queues (BullMQ)
# - Analytics: frequency tracking (sorted sets)
#
# This configuration assumes:
# - 1-2 GB RAM allocated to Redis
# - Persistence needed for queue reliability
# - Single node (no cluster mode)
# =============================================================================

# -----------------------------------------------------------------------------
# Network
# -----------------------------------------------------------------------------
bind 0.0.0.0
port 6379
protected-mode no

# TCP keepalive (seconds)
tcp-keepalive 300

# Backlog for incoming connections
tcp-backlog 511

# Timeout for idle connections (0 = disabled)
timeout 0

# -----------------------------------------------------------------------------
# Memory Management
# -----------------------------------------------------------------------------

# Max memory (set based on container limits)
maxmemory 1gb

# Eviction policy: LRU for cache keys, but preserve queues
# allkeys-lru: Evict any key using LRU
# volatile-lru: Only evict keys with TTL (our cache keys have TTL)
maxmemory-policy volatile-lru

# LRU sample size (higher = more accurate but slower)
maxmemory-samples 10

# Active defragmentation
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 25

# -----------------------------------------------------------------------------
# Persistence
# -----------------------------------------------------------------------------

# RDB snapshots (backup safety net)
save 900 1
save 300 10
save 60 10000

# RDB compression
rdbcompression yes
rdbchecksum yes

# AOF persistence (required for BullMQ reliability)
appendonly yes
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Mixed persistence (RDB for fast restart, AOF for durability)
aof-use-rdb-preamble yes

# -----------------------------------------------------------------------------
# Performance
# -----------------------------------------------------------------------------

# Lazy freeing (non-blocking deletes)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes

# IO threads for parallel reads (Redis 6+)
io-threads 4
io-threads-do-reads yes

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Disable THP (Transparent Huge Pages) warning
# Note: Also disable at OS level for best performance

# -----------------------------------------------------------------------------
# Replication (for read scaling)
# -----------------------------------------------------------------------------

# Replica settings (uncomment when adding replicas)
# replica-read-only yes
# replica-serve-stale-data yes
# repl-diskless-sync no
# repl-diskless-sync-delay 5

# -----------------------------------------------------------------------------
# Slow Log
# -----------------------------------------------------------------------------

# Log commands slower than 10ms
slowlog-log-slower-than 10000
slowlog-max-len 128

# -----------------------------------------------------------------------------
# Latency Monitoring
# -----------------------------------------------------------------------------

# Track latency spikes
latency-monitor-threshold 100

# -----------------------------------------------------------------------------
# Lua Scripting
# -----------------------------------------------------------------------------

# Time limit for Lua scripts (ms)
lua-time-limit 5000

# -----------------------------------------------------------------------------
# Cluster (disabled - single node)
# -----------------------------------------------------------------------------
cluster-enabled no

# -----------------------------------------------------------------------------
# Security
# -----------------------------------------------------------------------------

# Rename dangerous commands (uncomment for production)
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command DEBUG ""
# rename-command CONFIG "CONFIG_a8f3bc9d"
