# =============================================================================
# PostgreSQL Configuration for QuickLink
# =============================================================================
# Optimized for high-throughput URL shortening workload:
# - Heavy read (redirects) with async writes (click events)
# - OLTP workload with small transactions
# - Connection pooling via PgBouncer
#
# This configuration assumes:
# - 2-4 CPU cores
# - 4-8 GB RAM
# - SSD storage
#
# For production, tune based on actual hardware and monitoring.
# =============================================================================

# -----------------------------------------------------------------------------
# Connection Settings
# -----------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 200

# Reserved for superuser and replication
superuser_reserved_connections = 3

# -----------------------------------------------------------------------------
# Memory Settings
# -----------------------------------------------------------------------------

# Shared memory for caching (25% of total RAM)
shared_buffers = 1GB

# Per-connection memory for sorting/hashing
work_mem = 16MB

# Memory for maintenance operations (vacuum, index creation)
maintenance_work_mem = 256MB

# Effective cache size (includes OS cache, ~75% of RAM)
effective_cache_size = 3GB

# -----------------------------------------------------------------------------
# WAL Settings (Write-Ahead Log)
# -----------------------------------------------------------------------------

# WAL level for replication support
wal_level = replica

# Number of replication slots
max_replication_slots = 4

# Number of WAL senders for replicas
max_wal_senders = 4

# WAL segment size
wal_buffers = 64MB

# Checkpoint settings (less frequent = better performance, more data loss risk)
checkpoint_completion_target = 0.9
checkpoint_timeout = 10min
max_wal_size = 2GB
min_wal_size = 512MB

# -----------------------------------------------------------------------------
# Query Planner
# -----------------------------------------------------------------------------

# Cost estimates (SSD optimized)
random_page_cost = 1.1
seq_page_cost = 1.0
effective_io_concurrency = 200

# Parallel query settings
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------

# Log slow queries (> 100ms)
log_min_duration_statement = 100

# Log format for easier parsing
log_line_prefix = '%t [%p]: [%l-1] db=%d,user=%u,app=%a,client=%h '

# Log checkpoints for monitoring
log_checkpoints = on

# Log connection stats
log_connections = off
log_disconnections = off

# Log lock waits
log_lock_waits = on
deadlock_timeout = 1s

# -----------------------------------------------------------------------------
# Statistics
# -----------------------------------------------------------------------------

# Track I/O timing for EXPLAIN ANALYZE
track_io_timing = on

# Track function call statistics
track_functions = all

# -----------------------------------------------------------------------------
# Background Writer
# -----------------------------------------------------------------------------

# More aggressive background writing for consistent performance
bgwriter_delay = 50ms
bgwriter_lru_maxpages = 400
bgwriter_lru_multiplier = 4.0

# -----------------------------------------------------------------------------
# Autovacuum
# -----------------------------------------------------------------------------

# Autovacuum settings (more aggressive for high-churn tables)
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 30s
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05

# -----------------------------------------------------------------------------
# Client Connection Defaults
# -----------------------------------------------------------------------------

# Timezone
timezone = 'UTC'

# Default encoding
client_encoding = 'UTF8'

# Statement timeout (prevent runaway queries)
statement_timeout = 30000

# Lock timeout
lock_timeout = 10000

# -----------------------------------------------------------------------------
# Partitioning
# -----------------------------------------------------------------------------

# Enable partition pruning
enable_partition_pruning = on

# Parallel append for partitioned tables
enable_parallel_append = on

# Partition-wise joins
enable_partitionwise_join = on
enable_partitionwise_aggregate = on
