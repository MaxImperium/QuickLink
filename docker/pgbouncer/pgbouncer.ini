; =============================================================================
; PgBouncer Configuration for QuickLink
; =============================================================================
; Connection pooler for PostgreSQL to handle high connection counts
; efficiently without overloading the database server.
;
; Why PgBouncer?
; - PostgreSQL connections are expensive (~2-4MB per connection)
; - PgBouncer maintains a pool of DB connections and multiplexes clients
; - Reduces connection overhead from hundreds to dozens of actual connections
; - Enables "serverless" patterns where containers scale up/down
;
; Pool Modes:
; - session: Connection assigned for entire session (least efficient)
; - transaction: Connection assigned per transaction (recommended)
; - statement: Connection assigned per statement (most restrictive)
;
; =============================================================================

[databases]
; Connect to PostgreSQL using internal Docker network
; Format: dbname = host=hostname port=port dbname=dbname
quicklink = host=postgres port=5432 dbname=quicklink

; Read replica pool (uncomment when read replica is available)
; quicklink_readonly = host=postgres-replica port=5432 dbname=quicklink

[pgbouncer]
; =============================================================================
; Network Configuration
; =============================================================================
listen_addr = 0.0.0.0
listen_port = 6432

; Unix socket (disabled in Docker)
unix_socket_dir = 

; =============================================================================
; Authentication
; =============================================================================
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

; =============================================================================
; Pool Configuration
; =============================================================================

; Pool mode: transaction is ideal for web applications
; - Connections are returned to pool after each transaction
; - Allows high concurrency with few actual DB connections
pool_mode = transaction

; Maximum number of client connections (from application)
max_client_conn = 1000

; Default pool size per database/user pair
default_pool_size = 25

; Minimum pool size to keep ready
min_pool_size = 5

; Maximum pool size per database/user (hard limit)
max_db_connections = 50

; Reserve pool for burst traffic
reserve_pool_size = 5
reserve_pool_timeout = 3

; =============================================================================
; Connection Timeouts
; =============================================================================

; How long to wait for new connections before giving up
server_connect_timeout = 5

; How long a server connection can be idle before being closed
server_idle_timeout = 600

; How long a client can be idle in query
query_timeout = 30

; How long to wait for a response from server
query_wait_timeout = 120

; Client idle timeout (0 = disabled)
client_idle_timeout = 0

; =============================================================================
; Connection Lifetime
; =============================================================================

; Close server connection after it has been used this many seconds
server_lifetime = 3600

; Number of queries before reconnecting
max_server_queries = 50000

; =============================================================================
; Health & Monitoring
; =============================================================================

; Statistics logging interval (seconds)
stats_period = 60

; Log connections/disconnections
log_connections = 1
log_disconnections = 1

; Log DNS errors
log_pooler_errors = 1

; =============================================================================
; Admin Console
; =============================================================================

; Admin access requires authentication
admin_users = quicklink_admin
stats_users = quicklink_stats

; =============================================================================
; TCP Configuration
; =============================================================================

; TCP keepalive
tcp_keepalive = 1
tcp_keepidle = 60
tcp_keepintvl = 30
tcp_keepcnt = 3

; Disable Nagle's algorithm for lower latency
tcp_socket_buffer = 0

; =============================================================================
; Application Name
; =============================================================================

; Pass application_name to PostgreSQL for pg_stat_activity visibility
application_name_add_host = 1

; Ignore startup parameters that can cause issues
ignore_startup_parameters = extra_float_digits
